在iOS应用启动的时候,我们都知道入口函数是`main.m`的main方法:

`int main(int argc, char * argv[]) {...}`

但是这只是从应用层面上的入口,在这之前,系统加载的过程是非常值得我们了解和运用的



当应用程序被打开的时候,kernel就会将应用程序加载到内存中,然后kernel会加载另一个程序,就是我们的**dyld(动态连接器)**,不论是我们的应用还是dyld都是一个可执行的程序,在Mac OS和iOS上称作**`Mach-O`**



## Mach-O

简单介绍下`Mach-O`文件内容,就拿我们的app来说,找到编译后的`xxx.app`文件,这里是`Test.app`,包内有个`Test`执行文件,就是我们要找的`Mach-O`文件,这里使用`MachOView`这个软件来打开它,看看内部结构

![](../images/mach-o.png)


从图中可以看到,大致分成了下面三部分,其他的部分这里先不说

```
|------------|
|   __TEXT   |
|------------|		  
| 		  	 |
|   __DATA   |
|------------|
|	    	 |
| __LINKEDIT |
|		     |
|------------|
```

- __TEXT: 只读区域,包含了Mach Header,机器指令,只读的常量,执行代码等
- __DATA: 读写区域,包含了全局,静态变量,rebase的指针(后面会讲)
- __LINKEDIT: 只读区域,包含了如何加载程序,页面的Hash值(在内容签名的时候生成的),方法的参数名和地址等


虚拟内存加载dylib过程

加载Mach-O header -> 加载LINKEDIT的内容 -> 加载DATA数据 -> 卸载LINKEDIT内容

## 参考

dyld源码: https://github.com/opensource-apple/dyld

wwdc: https://developer.apple.com/videos/play/wwdc2016/406

Mach-O: https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/MachOTopics

